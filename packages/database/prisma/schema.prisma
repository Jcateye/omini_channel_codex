generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Platform {
  whatsapp
  twitter
  instagram
  tiktok
}

enum ChannelStatus {
  connected
  disconnected
  error
  pending
}

enum MessageType {
  text
}

enum MessageDirection {
  inbound
  outbound
}

enum MessageStatus {
  pending
  sent
  delivered
  read
  failed
}

enum ConversationStatus {
  open
  closed
  pending
}

enum LeadStage {
  new
  qualified
  nurtured
  converted
  lost
}

enum WebhookDeliveryStatus {
  pending
  success
  failed
}

enum CampaignStatus {
  draft
  scheduled
  running
  completed
  failed
  canceled
}

enum CampaignSendStatus {
  queued
  sent
  failed
  skipped
}

enum AttributionModel {
  last_touch
}

enum ToolKind {
  internal
  external
}

enum ToolExecutionStatus {
  success
  error
  denied
}

enum PromptOutcome {
  success
  failure
  unknown
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  apiKeys            ApiKey[]
  channels           Channel[]
  contacts           Contact[]
  contactIdentifiers ContactIdentifier[]
  conversations      Conversation[]
  messages           Message[]
  leads              Lead[]
  campaigns          Campaign[]
  campaignSegments   CampaignSegment[]
  campaignSends      CampaignSend[]
  webhookDeliveries  WebhookDelivery[]
  leadAttributions   LeadAttribution[]
  analyticsDaily     AnalyticsDaily[]
  toolDefinitions    ToolDefinition[]
  toolPermissions    ToolPermission[]
  promptTemplates    PromptTemplate[]
  promptUsages       PromptUsage[]
  toolExecutionLogs  ToolExecutionLog[]
}

model ApiKey {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  prefix         String   @unique
  hash           String
  lastUsedAt     DateTime?
  revokedAt      DateTime?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model Channel {
  id             String        @id @default(uuid())
  organizationId String
  platform       Platform
  provider       String?
  name           String
  externalId     String
  status         ChannelStatus
  credentials    Json
  settings       Json?
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id])
  conversations Conversation[]
  messages      Message[]
  campaigns     Campaign[]
  leadAttributions LeadAttribution[]
  analyticsDaily   AnalyticsDaily[]

  @@index([organizationId])
  @@unique([organizationId, platform, externalId])
}

model Contact {
  id             String   @id @default(uuid())
  organizationId String
  name           String?
  email          String?
  phone          String?
  tags           String[] @default([])
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  identifiers ContactIdentifier[]
  conversations Conversation[]
  messages      Message[]
  leads         Lead[]

  @@index([organizationId])
  @@index([organizationId, phone])
}

model ContactIdentifier {
  id             String   @id @default(uuid())
  organizationId String
  contactId      String
  platform       Platform
  externalId     String
  handle         String?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  contact      Contact      @relation(fields: [contactId], references: [id])

  @@unique([organizationId, platform, externalId])
  @@index([contactId])
}

model Conversation {
  id             String             @id @default(uuid())
  organizationId String
  channelId      String
  contactId      String
  platform       Platform
  externalId     String
  status         ConversationStatus
  lastMessageAt  DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  channel      Channel      @relation(fields: [channelId], references: [id])
  contact      Contact      @relation(fields: [contactId], references: [id])
  messages     Message[]
  leads        Lead[]

  @@index([organizationId])
  @@index([channelId])
  @@index([contactId])
  @@unique([channelId, externalId])
}

model Message {
  id             String           @id @default(uuid())
  organizationId String
  conversationId String
  channelId      String
  contactId      String
  platform       Platform
  externalId     String?
  type           MessageType
  direction      MessageDirection
  status         MessageStatus
  content        Json
  rawPayload     Json?
  sentAt         DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])
  channel      Channel      @relation(fields: [channelId], references: [id])
  contact      Contact      @relation(fields: [contactId], references: [id])
  campaignSends CampaignSend[]
  leadAttributions LeadAttribution[]

  @@index([organizationId])
  @@index([conversationId])
  @@index([channelId])
  @@index([contactId])
}

model Lead {
  id             String    @id @default(uuid())
  organizationId String
  contactId      String?
  conversationId String?
  stage          LeadStage @default(new)
  score          Float?
  tags           String[]  @default([])
  source         String?
  metadata       Json?
  lastActivityAt DateTime?
  convertedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  contact      Contact?     @relation(fields: [contactId], references: [id])
  conversation Conversation? @relation(fields: [conversationId], references: [id])
  campaignSends CampaignSend[]
  attributions LeadAttribution[]

  @@index([organizationId])
  @@index([contactId])
}

model Campaign {
  id             String         @id @default(uuid())
  organizationId String
  channelId      String
  name           String
  messageText    String
  status         CampaignStatus @default(draft)
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  cost           Float?
  revenue        Float?
  totalQueued    Int            @default(0)
  totalSent      Int            @default(0)
  totalFailed    Int            @default(0)
  totalSkipped   Int            @default(0)
  segmentId      String?        @unique
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization Organization   @relation(fields: [organizationId], references: [id])
  channel      Channel        @relation(fields: [channelId], references: [id])
  segment      CampaignSegment? @relation(fields: [segmentId], references: [id])
  sends        CampaignSend[]
  attributions LeadAttribution[]
  analyticsDaily AnalyticsDaily[]

  @@index([organizationId])
  @@index([channelId])
  @@index([status])
  @@index([scheduledAt])
}

model CampaignSegment {
  id                   String   @id @default(uuid())
  organizationId       String
  stages               LeadStage[] @default([])
  tagsAll              String[] @default([])
  sources              String[] @default([])
  lastActiveWithinDays Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  campaign     Campaign?

  @@index([organizationId])
}

model CampaignSend {
  id             String            @id @default(uuid())
  organizationId String
  campaignId     String
  leadId         String
  messageId      String?
  status         CampaignSendStatus @default(queued)
  errorMessage   String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  campaign     Campaign     @relation(fields: [campaignId], references: [id])
  lead         Lead         @relation(fields: [leadId], references: [id])
  message      Message?     @relation(fields: [messageId], references: [id])

  @@index([organizationId])
  @@index([campaignId])
  @@index([leadId])
  @@unique([campaignId, leadId])
}

model WebhookDelivery {
  id             String                @id @default(uuid())
  organizationId String
  eventType      String
  targetUrl      String
  payload        Json
  status         WebhookDeliveryStatus @default(pending)
  responseCode   Int?
  errorMessage   String?
  attempt        Int                   @default(0)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model ToolDefinition {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  version        String
  kind           ToolKind
  provider       String?
  description    String?
  protocol       String   @default("v1")
  schema         Json
  config         Json?
  auth           Json?
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id])
  permissions  ToolPermission[]
  executions   ToolExecutionLog[]

  @@index([organizationId])
  @@unique([organizationId, name, version])
}

model ToolPermission {
  id             String   @id @default(uuid())
  organizationId String
  toolId         String
  agentId        String?
  allowed        Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  tool         ToolDefinition @relation(fields: [toolId], references: [id])

  @@index([organizationId])
  @@index([toolId])
  @@unique([organizationId, toolId, agentId])
}

model PromptTemplate {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  version        String
  content        String
  metadata       Json?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  usages       PromptUsage[]

  @@index([organizationId])
  @@unique([organizationId, name, version])
}

model PromptUsage {
  id             String        @id @default(uuid())
  organizationId String
  promptId       String
  agentId        String?
  outcome        PromptOutcome @default(unknown)
  latencyMs      Int?
  metadata       Json?
  createdAt      DateTime      @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  prompt       PromptTemplate @relation(fields: [promptId], references: [id])

  @@index([organizationId])
  @@index([promptId])
  @@index([agentId])
  @@index([outcome])
}

model ToolExecutionLog {
  id             String             @id @default(uuid())
  organizationId String
  toolId         String
  agentId        String?
  status         ToolExecutionStatus
  latencyMs      Int?
  errorMessage   String?
  requestPayload Json
  responsePayload Json?
  createdAt      DateTime           @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  tool         ToolDefinition @relation(fields: [toolId], references: [id])

  @@index([organizationId])
  @@index([toolId])
  @@index([agentId])
}

model LeadAttribution {
  id             String           @id @default(uuid())
  organizationId String
  leadId         String
  campaignId     String?
  messageId      String?
  channelId      String?
  model          AttributionModel @default(last_touch)
  attributedAt   DateTime
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  lead         Lead         @relation(fields: [leadId], references: [id])
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])
  message      Message?     @relation(fields: [messageId], references: [id])
  channel      Channel?     @relation(fields: [channelId], references: [id])

  @@unique([leadId, model])
  @@index([organizationId])
  @@index([campaignId])
  @@index([channelId])
  @@index([attributedAt])
}

model AnalyticsDaily {
  id                     String   @id @default(uuid())
  organizationId         String
  date                   DateTime
  channelId              String?
  campaignId             String?
  outboundSent           Int      @default(0)
  outboundDelivered      Int      @default(0)
  outboundFailed         Int      @default(0)
  inboundCount           Int      @default(0)
  responseCount          Int      @default(0)
  leadCreated            Int      @default(0)
  leadConverted          Int      @default(0)
  attributedConversions  Int      @default(0)
  attributedRevenue      Float?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  channel      Channel?     @relation(fields: [channelId], references: [id])
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])

  @@unique([organizationId, date, channelId, campaignId])
  @@index([organizationId])
  @@index([date])
}
