generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Platform {
  whatsapp
  twitter
  instagram
  tiktok
}

enum ChannelStatus {
  connected
  disconnected
  error
  pending
}

enum MessageType {
  text
}

enum MessageDirection {
  inbound
  outbound
}

enum MessageStatus {
  pending
  sent
  delivered
  read
  failed
}

enum ConversationStatus {
  open
  closed
  pending
}

enum LeadStage {
  new
  qualified
  nurtured
  converted
  lost
}

enum WebhookDeliveryStatus {
  pending
  success
  failed
}

enum CampaignStatus {
  draft
  scheduled
  running
  completed
  failed
  canceled
}

enum CampaignSendStatus {
  queued
  sent
  failed
  skipped
}

enum AttributionModel {
  first_touch
  last_touch
  linear
}

enum JourneyStatus {
  draft
  active
  paused
  archived
}

enum JourneyTriggerType {
  inbound_message
  tag_change
  stage_change
  time
}

enum JourneyNodeType {
  send_message
  delay
  condition
  tag_update
  webhook
}

enum JourneyRunStatus {
  pending
  running
  completed
  failed
  canceled
}

enum JourneyStepStatus {
  pending
  running
  completed
  failed
  skipped
}

enum ToolKind {
  internal
  external
}

enum ToolExecutionStatus {
  success
  error
  denied
}

enum PromptOutcome {
  success
  failure
  unknown
}

enum AgentMemoryScope {
  session
  lead
}

enum AgentRunType {
  lead_scoring
  campaign_optimization
}

enum AgentRunStatus {
  pending
  completed
  failed
}

enum CampaignOptimizationStatus {
  pending
  applied
  dismissed
}

enum KnowledgeSourceType {
  manual
  web
  notion
  google_docs
}

enum KnowledgeSyncStatus {
  pending
  running
  completed
  failed
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  apiKeys            ApiKey[]
  channels           Channel[]
  contacts           Contact[]
  contactIdentifiers ContactIdentifier[]
  conversations      Conversation[]
  messages           Message[]
  leads              Lead[]
  campaigns          Campaign[]
  campaignSegments   CampaignSegment[]
  campaignSends      CampaignSend[]
  webhookDeliveries  WebhookDelivery[]
  leadAttributions   LeadAttribution[]
  analyticsDaily     AnalyticsDaily[]
  toolDefinitions    ToolDefinition[]
  toolPermissions    ToolPermission[]
  promptTemplates    PromptTemplate[]
  promptUsages       PromptUsage[]
  toolExecutionLogs  ToolExecutionLog[]
  revenueEvents      RevenueEvent[]
  journeys           Journey[]
  journeyTriggers    JourneyTrigger[]
  journeyNodes       JourneyNode[]
  journeyEdges       JourneyEdge[]
  journeyRuns        JourneyRun[]
  journeyRunSteps    JourneyRunStep[]
  attributionTouchpoints AttributionTouchpoint[]
  aiIntentWindows    AiIntentWindow[]
  aiTopicClusters    AiTopicCluster[]
  aiReplySuggestions AiReplySuggestion[]
  agentMemories      AgentMemory[]
  knowledgeSources   KnowledgeSource[]
  knowledgeChunks    KnowledgeChunk[]
  agentRuns          AgentRun[]
  campaignOptimizations CampaignOptimization[]
  leadAssignmentLogs LeadAssignmentLog[]
  agentHandoffLogs AgentHandoffLog[]
  knowledgeSyncs     KnowledgeSync[]
}

model ApiKey {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  prefix         String   @unique
  hash           String
  lastUsedAt     DateTime?
  revokedAt      DateTime?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model Channel {
  id             String        @id @default(uuid())
  organizationId String
  platform       Platform
  provider       String?
  name           String
  externalId     String
  status         ChannelStatus
  credentials    Json
  settings       Json?
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id])
  conversations Conversation[]
  messages      Message[]
  campaigns     Campaign[]
  leadAttributions LeadAttribution[]
  attributionTouchpoints AttributionTouchpoint[]
  analyticsDaily   AnalyticsDaily[]
  journeyRuns     JourneyRun[]

  @@index([organizationId])
  @@unique([organizationId, platform, externalId])
}

model Contact {
  id             String   @id @default(uuid())
  organizationId String
  name           String?
  email          String?
  phone          String?
  tags           String[] @default([])
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  identifiers ContactIdentifier[]
  conversations Conversation[]
  messages      Message[]
  leads         Lead[]

  @@index([organizationId])
  @@index([organizationId, phone])
}

model ContactIdentifier {
  id             String   @id @default(uuid())
  organizationId String
  contactId      String
  platform       Platform
  externalId     String
  handle         String?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  contact      Contact      @relation(fields: [contactId], references: [id])

  @@unique([organizationId, platform, externalId])
  @@index([contactId])
}

model Conversation {
  id             String             @id @default(uuid())
  organizationId String
  channelId      String
  contactId      String
  platform       Platform
  externalId     String
  status         ConversationStatus
  lastMessageAt  DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  channel      Channel      @relation(fields: [channelId], references: [id])
  contact      Contact      @relation(fields: [contactId], references: [id])
  messages     Message[]
  leads        Lead[]

  @@index([organizationId])
  @@index([channelId])
  @@index([contactId])
  @@unique([channelId, externalId])
}

model Message {
  id             String           @id @default(uuid())
  organizationId String
  conversationId String
  channelId      String
  contactId      String
  platform       Platform
  externalId     String?
  type           MessageType
  direction      MessageDirection
  status         MessageStatus
  content        Json
  rawPayload     Json?
  sentAt         DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])
  channel      Channel      @relation(fields: [channelId], references: [id])
  contact      Contact      @relation(fields: [contactId], references: [id])
  campaignSends CampaignSend[]
  leadAttributions LeadAttribution[]
  journeyRunSteps JourneyRunStep[]
  attributionTouchpoints AttributionTouchpoint[]

  @@index([organizationId])
  @@index([conversationId])
  @@index([channelId])
  @@index([contactId])
}

model Lead {
  id             String    @id @default(uuid())
  organizationId String
  contactId      String?
  conversationId String?
  stage          LeadStage @default(new)
  score          Float?
  tags           String[]  @default([])
  source         String?
  metadata       Json?
  lastActivityAt DateTime?
  convertedAt    DateTime?
  crmExternalId  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  contact      Contact?     @relation(fields: [contactId], references: [id])
  conversation Conversation? @relation(fields: [conversationId], references: [id])
  campaignSends CampaignSend[]
  attributions LeadAttribution[]
  attributionTouchpoints AttributionTouchpoint[]
  revenueEvents RevenueEvent[]
  journeyRuns  JourneyRun[]
  agentMemories AgentMemory[]
  agentRuns     AgentRun[]
  assignmentLogs LeadAssignmentLog[]
  handoffLogs   AgentHandoffLog[]

  @@index([organizationId])
  @@index([contactId])
  @@index([crmExternalId])
}

model Campaign {
  id             String         @id @default(uuid())
  organizationId String
  channelId      String
  name           String
  messageText    String
  metadata       Json?
  status         CampaignStatus @default(draft)
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  cost           Float?
  revenue        Float?
  totalQueued    Int            @default(0)
  totalSent      Int            @default(0)
  totalFailed    Int            @default(0)
  totalSkipped   Int            @default(0)
  segmentId      String?        @unique
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization Organization   @relation(fields: [organizationId], references: [id])
  channel      Channel        @relation(fields: [channelId], references: [id])
  segment      CampaignSegment? @relation(fields: [segmentId], references: [id])
  sends        CampaignSend[]
  attributions LeadAttribution[]
  attributionTouchpoints AttributionTouchpoint[]
  analyticsDaily AnalyticsDaily[]
  revenueEvents RevenueEvent[]
  agentRuns     AgentRun[]
  optimizations CampaignOptimization[]

  @@index([organizationId])
  @@index([channelId])
  @@index([status])
  @@index([scheduledAt])
}

model CampaignSegment {
  id                   String   @id @default(uuid())
  organizationId       String
  stages               LeadStage[] @default([])
  tagsAll              String[] @default([])
  sources              String[] @default([])
  lastActiveWithinDays Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  campaign     Campaign?

  @@index([organizationId])
}

model CampaignSend {
  id             String            @id @default(uuid())
  organizationId String
  campaignId     String
  leadId         String
  messageId      String?
  status         CampaignSendStatus @default(queued)
  errorMessage   String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  campaign     Campaign     @relation(fields: [campaignId], references: [id])
  lead         Lead         @relation(fields: [leadId], references: [id])
  message      Message?     @relation(fields: [messageId], references: [id])

  @@index([organizationId])
  @@index([campaignId])
  @@index([leadId])
  @@unique([campaignId, leadId])
}

model Journey {
  id             String        @id @default(uuid())
  organizationId String
  name           String
  description    String?
  status         JourneyStatus @default(draft)
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  triggers    JourneyTrigger[]
  nodes       JourneyNode[]
  edges       JourneyEdge[]
  runs        JourneyRun[]
  attributions AttributionTouchpoint[]

  @@index([organizationId])
  @@index([status])
}

model JourneyTrigger {
  id             String             @id @default(uuid())
  organizationId String
  journeyId      String
  type           JourneyTriggerType
  enabled        Boolean            @default(true)
  config         Json?
  lastFiredAt    DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  journey      Journey      @relation(fields: [journeyId], references: [id])

  @@index([organizationId])
  @@index([journeyId])
  @@index([type])
}

model JourneyNode {
  id             String          @id @default(uuid())
  organizationId String
  journeyId      String
  type           JourneyNodeType
  label          String?
  config         Json?
  position       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  journey      Journey      @relation(fields: [journeyId], references: [id])
  outgoingEdges JourneyEdge[] @relation("JourneyEdgeFrom")
  incomingEdges JourneyEdge[] @relation("JourneyEdgeTo")
  runSteps     JourneyRunStep[]

  @@index([organizationId])
  @@index([journeyId])
  @@index([type])
}

model JourneyEdge {
  id             String   @id @default(uuid())
  organizationId String
  journeyId      String
  fromNodeId     String
  toNodeId       String
  label          String?
  config         Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  journey      Journey      @relation(fields: [journeyId], references: [id])
  fromNode     JourneyNode  @relation("JourneyEdgeFrom", fields: [fromNodeId], references: [id])
  toNode       JourneyNode  @relation("JourneyEdgeTo", fields: [toNodeId], references: [id])

  @@index([organizationId])
  @@index([journeyId])
  @@index([fromNodeId])
  @@index([toNodeId])
}

model JourneyRun {
  id             String           @id @default(uuid())
  organizationId String
  journeyId      String
  leadId         String?
  contactId      String?
  channelId      String?
  triggerType    JourneyTriggerType
  triggerPayload Json?
  status         JourneyRunStatus @default(pending)
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  journey      Journey      @relation(fields: [journeyId], references: [id])
  lead         Lead?        @relation(fields: [leadId], references: [id])
  contact      Contact?     @relation(fields: [contactId], references: [id])
  channel      Channel?     @relation(fields: [channelId], references: [id])
  steps        JourneyRunStep[]
  attributions AttributionTouchpoint[]

  @@index([organizationId])
  @@index([journeyId])
  @@index([leadId])
  @@index([status])
}

model JourneyRunStep {
  id             String           @id @default(uuid())
  organizationId String
  runId          String
  nodeId         String
  status         JourneyStepStatus @default(pending)
  attempt        Int              @default(0)
  scheduledFor   DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  errorMessage   String?
  output         Json?
  messageId      String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  run          JourneyRun  @relation(fields: [runId], references: [id])
  node         JourneyNode @relation(fields: [nodeId], references: [id])
  message      Message?    @relation(fields: [messageId], references: [id])

  @@index([organizationId])
  @@index([runId])
  @@index([nodeId])
  @@index([status])
}

model WebhookDelivery {
  id             String                @id @default(uuid())
  organizationId String
  eventType      String
  targetUrl      String
  payload        Json
  status         WebhookDeliveryStatus @default(pending)
  responseCode   Int?
  errorMessage   String?
  attempt        Int                   @default(0)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model AiIntentWindow {
  id             String   @id @default(uuid())
  organizationId String
  windowStart    DateTime
  intent         String
  count          Int      @default(0)
  sampleMessages Json?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([windowStart])
  @@index([intent])
  @@unique([organizationId, windowStart, intent])
}

model AiTopicCluster {
  id             String   @id @default(uuid())
  organizationId String
  windowStart    DateTime
  label          String
  count          Int      @default(0)
  sampleMessages Json?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([windowStart])
  @@index([label])
  @@unique([organizationId, windowStart, label])
}

model AiReplySuggestion {
  id             String   @id @default(uuid())
  organizationId String
  windowStart    DateTime
  intent         String
  suggestions    Json
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([windowStart])
  @@index([intent])
  @@unique([organizationId, windowStart, intent])
}

model ToolDefinition {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  version        String
  kind           ToolKind
  provider       String?
  description    String?
  protocol       String   @default("v1")
  schema         Json
  config         Json?
  auth           Json?
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id])
  permissions  ToolPermission[]
  executions   ToolExecutionLog[]

  @@index([organizationId])
  @@unique([organizationId, name, version])
}

model ToolPermission {
  id             String   @id @default(uuid())
  organizationId String
  toolId         String
  agentId        String?
  allowed        Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  tool         ToolDefinition @relation(fields: [toolId], references: [id])

  @@index([organizationId])
  @@index([toolId])
  @@unique([organizationId, toolId, agentId])
}

model PromptTemplate {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  version        String
  content        String
  metadata       Json?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  usages       PromptUsage[]

  @@index([organizationId])
  @@unique([organizationId, name, version])
}

model PromptUsage {
  id             String        @id @default(uuid())
  organizationId String
  promptId       String
  agentId        String?
  outcome        PromptOutcome @default(unknown)
  latencyMs      Int?
  metadata       Json?
  createdAt      DateTime      @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  prompt       PromptTemplate @relation(fields: [promptId], references: [id])

  @@index([organizationId])
  @@index([promptId])
  @@index([agentId])
  @@index([outcome])
}

model ToolExecutionLog {
  id             String             @id @default(uuid())
  organizationId String
  toolId         String
  agentId        String?
  status         ToolExecutionStatus
  latencyMs      Int?
  errorMessage   String?
  requestPayload Json
  responsePayload Json?
  createdAt      DateTime           @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  tool         ToolDefinition @relation(fields: [toolId], references: [id])

  @@index([organizationId])
  @@index([toolId])
  @@index([agentId])
}

model LeadAttribution {
  id             String           @id @default(uuid())
  organizationId String
  leadId         String
  campaignId     String?
  messageId      String?
  channelId      String?
  journeyId      String?
  model          AttributionModel @default(last_touch)
  attributedAt   DateTime
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  lead         Lead         @relation(fields: [leadId], references: [id])
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])
  message      Message?     @relation(fields: [messageId], references: [id])
  channel      Channel?     @relation(fields: [channelId], references: [id])
  journey      Journey?     @relation(fields: [journeyId], references: [id])

  @@unique([leadId, model])
  @@index([organizationId])
  @@index([campaignId])
  @@index([channelId])
  @@index([journeyId])
  @@index([attributedAt])
}

model AttributionTouchpoint {
  id             String           @id @default(uuid())
  organizationId String
  leadId         String
  model          AttributionModel @default(last_touch)
  campaignId     String?
  journeyId      String?
  journeyRunId   String?
  messageId      String?
  channelId      String?
  weight         Float            @default(1)
  touchedAt      DateTime
  createdAt      DateTime         @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  lead         Lead         @relation(fields: [leadId], references: [id])
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])
  journey      Journey?     @relation(fields: [journeyId], references: [id])
  journeyRun   JourneyRun?  @relation(fields: [journeyRunId], references: [id])
  message      Message?     @relation(fields: [messageId], references: [id])
  channel      Channel?     @relation(fields: [channelId], references: [id])

  @@index([organizationId])
  @@index([leadId])
  @@index([campaignId])
  @@index([journeyId])
  @@index([journeyRunId])
  @@index([channelId])
  @@index([touchedAt])
}

model AnalyticsDaily {
  id                     String   @id @default(uuid())
  organizationId         String
  date                   DateTime
  channelId              String?
  campaignId             String?
  outboundSent           Int      @default(0)
  outboundDelivered      Int      @default(0)
  outboundFailed         Int      @default(0)
  inboundCount           Int      @default(0)
  responseCount          Int      @default(0)
  leadCreated            Int      @default(0)
  leadConverted          Int      @default(0)
  attributedConversions  Int      @default(0)
  attributedRevenue      Float?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  channel      Channel?     @relation(fields: [channelId], references: [id])
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])

  @@unique([organizationId, date, channelId, campaignId])
  @@index([organizationId])
  @@index([date])
}

model RevenueEvent {
  id             String   @id @default(uuid())
  organizationId String
  leadId         String?
  campaignId     String?
  amount         Float
  currency       String
  source         String
  externalId     String?
  occurredAt     DateTime
  metadata       Json?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  lead         Lead?        @relation(fields: [leadId], references: [id])
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])

  @@index([organizationId])
  @@index([leadId])
  @@index([campaignId])
  @@index([occurredAt])
  @@unique([organizationId, source, externalId])
}

model AgentMemory {
  id             String          @id @default(uuid())
  organizationId String
  scope          AgentMemoryScope
  sessionId      String?
  leadId         String?
  key            String?
  content        Json
  metadata       Json?
  expiresAt      DateTime
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  lead         Lead?        @relation(fields: [leadId], references: [id])

  @@index([organizationId])
  @@index([leadId])
  @@index([expiresAt])
}

model KnowledgeSource {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  description    String?
  kind           KnowledgeSourceType
  config         Json?
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id])
  chunks       KnowledgeChunk[]
  syncs        KnowledgeSync[]

  @@index([organizationId])
}

model KnowledgeChunk {
  id             String   @id @default(uuid())
  organizationId String
  sourceId       String
  content        String
  metadata       Json?
  vectorId       String?
  createdAt      DateTime @default(now())

  organization Organization   @relation(fields: [organizationId], references: [id])
  source       KnowledgeSource @relation(fields: [sourceId], references: [id])

  @@index([organizationId])
  @@index([sourceId])
  @@index([vectorId])
}

model AgentRun {
  id             String        @id @default(uuid())
  organizationId String
  type           AgentRunType
  status         AgentRunStatus @default(pending)
  leadId         String?
  campaignId     String?
  input          Json?
  output         Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  lead         Lead?        @relation(fields: [leadId], references: [id])
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])
  steps        AgentRunStep[]

  @@index([organizationId])
  @@index([leadId])
  @@index([campaignId])
}

model AgentRunStep {
  id         String   @id @default(uuid())
  runId      String
  stepIndex  Int
  stepType   String
  status     String
  input      Json?
  output     Json?
  startedAt  DateTime @default(now())
  finishedAt DateTime?

  run AgentRun @relation(fields: [runId], references: [id])

  @@index([runId])
}

model CampaignOptimization {
  id             String                     @id @default(uuid())
  organizationId String
  campaignId     String
  type           String
  title          String
  description    String
  status         CampaignOptimizationStatus @default(pending)
  metrics        Json?
  action         Json?
  appliedAt      DateTime?
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  campaign     Campaign     @relation(fields: [campaignId], references: [id])

  @@index([organizationId])
  @@index([campaignId])
  @@index([status])
}

model LeadAssignmentLog {
  id             String   @id @default(uuid())
  organizationId String
  leadId         String
  strategy       String
  targetId       String
  targetType     String
  targetName     String?
  rationale      Json?
  metadata       Json?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  lead         Lead         @relation(fields: [leadId], references: [id])

  @@index([organizationId])
  @@index([leadId])
  @@index([strategy])
}

model AgentHandoffLog {
  id             String   @id @default(uuid())
  organizationId String
  leadId         String
  fromRole       String?
  toRole         String
  triggerType    String
  triggerRuleId  String?
  triggerDetail  Json?
  contextShared  Json?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  lead         Lead         @relation(fields: [leadId], references: [id])

  @@index([organizationId])
  @@index([leadId])
  @@index([toRole])
}

model KnowledgeSync {
  id             String            @id @default(uuid())
  organizationId String
  sourceId       String
  status         KnowledgeSyncStatus @default(pending)
  startedAt      DateTime?
  completedAt    DateTime?
  errorMessage   String?
  metadata       Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id])
  source       KnowledgeSource @relation(fields: [sourceId], references: [id])

  @@index([organizationId])
  @@index([sourceId])
  @@index([status])
}
